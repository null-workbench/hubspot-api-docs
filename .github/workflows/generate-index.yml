name: Generate index.json

on:
  workflow_dispatch:
  push:
    paths:
      - "PublicApiSpecs/**"
      - ".github/workflows/generate-index.yml"

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate index.json
        shell: bash
        run: |
          set -euo pipefail

          OUT="index.json"

          echo '{' > "$OUT"
          echo '  "repo": "null-workbench/hubspot-api-docs",' >> "$OUT"
          echo '  "root": "PublicApiSpecs",' >> "$OUT"
          echo '  "generatedAt": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'",' >> "$OUT"
          echo '  "files": [' >> "$OUT"

          first=true
          while IFS= read -r file; do
            if [ "$first" = true ]; then
              first=false
            else
              echo ',' >> "$OUT"
            fi

            area=$(echo "$file" | cut -d'/' -f2)
            version=$(echo "$file" | grep -o '/v[0-9]\+' | head -n1 | tr -d '/' || true)

            # Keywords from path tokens
            kw_lines=$(echo "$file" \
              | sed 's|^PublicApiSpecs/||' \
              | tr '/ _-&' '\n' \
              | tr '[:upper:]' '[:lower:]' \
              | sed '/^$/d' \
              | sed '/^v[0-9]\+$/d' \
              | sed '/^rollouts$/d' \
              | sed '/^[0-9]\+$/d' \
              | sed '/^collection$/d' \
              | sed '/^directory$/d' \
              | sort -u)

            keywords_json=$(printf '%s\n' "$kw_lines" | awk 'BEGIN{ORS=""; first=1} {gsub(/"/,"\\\""); if(first){printf "\"%s\"", $0; first=0}else{printf ",\"%s\"", $0}}')

            echo '    {' >> "$OUT"
            echo '      "path": "'"$file"'",' >> "$OUT"
            echo '      "area": "'"$area"'",' >> "$OUT"
            echo '      "version": "'"${version:-unknown}"'",' >> "$OUT"
            echo '      "keywords": ['"$keywords_json"']' >> "$OUT"
            echo '    }' >> "$OUT"
          done < <(find PublicApiSpecs -type f -name "*.json" | sort)

          echo '' >> "$OUT"
          echo '  ]' >> "$OUT"
          echo '}' >> "$OUT"

      - name: Commit index.json
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add index.json
          git commit -m "Auto-generate index.json" || exit 0
          git push
