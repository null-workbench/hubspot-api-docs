name: Generate index.json (v2)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate index.json with keywords
        shell: bash
        run: |
          set -euo pipefail
          OUT="index.json"

          printf '{\n' > "$OUT"
          printf '  "repo": "null-workbench/hubspot-api-docs",\n' >> "$OUT"
          printf '  "root": "PublicApiSpecs",\n' >> "$OUT"
          printf '  "generatedAt": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$OUT"
          printf '  "files": [\n' >> "$OUT"

          first=1
          while IFS= read -r file; do
            area=$(echo "$file" | cut -d'/' -f2)
            version=$(echo "$file" | grep -o '/v[0-9]\+' | head -n1 | tr -d '/' || true)

            kw_lines=$(echo "$file" \
              | sed 's|^PublicApiSpecs/||' \
              | sed 's|[\/ _&-]|\n|g' \
              | tr '[:upper:]' '[:lower:]' \
              | sed '/^$/d' \
              | sed '/^v[0-9]\+$/d' \
              | sed '/^rollouts$/d' \
              | sed '/^[0-9]\+$/d' \
              | sed '/^collection$/
